<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Astrona â€” Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="assets/icons/favicon.png">
</head>
<body>
  <div class="nav-bar">
    <button class="icon-btn" onclick="history.back()" title="Back">
      <img src="assets/icons/arrow-left.png" alt="Back" class="nav-icon">
    </button>
    <div class="brand">Astrona Settings</div>
    <div class="spacer"></div>
    <button id="themeToggleBtn" class="icon-btn" title="Switch theme">
      <img id="themeIcon" src="assets/icons/sun.png" alt="Theme" class="nav-icon">
    </button>
  </div>

  <main class="container narrow">
    <section class="card">
      <h1>
        <img src="assets/icons/user.png" alt="Profile" class="heading-icon">
        Profile
      </h1>
      <div id="me"></div>
      <form id="profileForm">
        <div class="row"><label>Username</label><input type="text" name="username" maxlength="20"></div>
        <div class="row"><label>Avatar</label><input type="file" name="avatar" accept="image/*"></div>
        <button class="primary icon-btn" type="submit"><img src="assets/icons/edit.png" alt="Save"> Save</button>
      </form>
    </section>

    <section class="card">
      <h1>
        <img src="assets/icons/block.png" alt="Blocking" class="heading-icon">
        Blocking
      </h1>
      <form id="blockForm">
        <div class="row"><label>Number</label><input type="text" name="number" placeholder="1234-5678" pattern="\\d{4}-\\d{4}"></div>
        <button class="danger icon-btn" type="submit"><img src="assets/icons/block.png" alt="Block"> Block</button>
      </form>
      <form id="unblockForm">
        <div class="row"><label>Number</label><input type="text" name="number" placeholder="1234-5678" pattern="\\d{4}-\\d{4}"></div>
        <button class="ghost icon-btn" type="submit"><img src="assets/icons/unblock.png" alt="Unblock"> Unblock</button>
      </form>
    </section>
  </main>

  <script src="ui.js"></script>
  <script src="app.js"></script>
  <script src="api.js"></script>
  <script>
    UI.initPopup();
    document.getElementById('themeToggleBtn').addEventListener('click', UI.toggleTheme);
    APP.ensureAuth();

    async function loadMe() {
      const { profile } = await API.me();
      me.innerHTML = `
        <div class="profile">
          <img class="avatar" src="${profile.avatar || 'assets/default-avatar.png'}" alt="Avatar">
          <div>
            <div><strong>Username:</strong> ${profile.username}</div>
            <div><strong>Number:</strong> ${profile.number}</div>
          </div>
        </div>
      `;
      profileForm.username.value = profile.username;
    }

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(profileForm);
      const { data, error } = await API.updateProfile(fd);
      if (error) return UI.popup(error);
      UI.popup('Profile updated', loadMe);
    });

    blockForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(blockForm);
      const { error } = await API.block(fd.get('number'));
      if (error) return UI.popup(error);
      UI.popup('Blocked');
    });

    unblockForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(unblockForm);
      const { error } = await API.unblock(fd.get('number'));
      if (error) return UI.popup(error);
      UI.popup('Unblocked');
    });

    loadMe();
  </script>
</body>
</html>
